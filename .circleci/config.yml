version: 2.1
commands:
  nococid-start-workflow-command:
    steps:
      - run:
          name: "Trigger start workflow to Nococid"
          command: curl -X POST "http://toan0701.ddns.net:9080/Nococid/api/Listeners/CircleCI/start-workflow?gh_username=${CIRCLE_PROJECT_USERNAME}&circle_workflow_id=${CIRCLE_WORKFLOW_ID}" --header "Content-Type:application/json" --data '{"ProjectId":"1641e7e4-c2c6-47e1-60e5-08d9012998b9","TotalJob":2,"StagesAndNames":[{"StageCode":3,"StageName":"test-1"},{"StageCode":2,"StageName":"build-2"}]}'
  nococid-start-job-command:
    steps:
      - run:
          name: "Trigger start job to Nococid"
          command: curl -X POST "http://toan0701.ddns.net:9080/Nococid/api/Listeners/CircleCI/start-job?circle_workflow_id=${CIRCLE_WORKFLOW_ID}&stage=${CIRCLE_STAGE}&gh_username=${CIRCLE_PROJECT_USERNAME}" --header "Content-Type:application/json" --data ''
  nococid-end-job-command:
    steps:
      - run:
          when: always
          name: "Trigger end job to Nococid"
          command: curl -X POST "http://toan0701.ddns.net:9080/Nococid/api/Listeners/CircleCI/end-job?circle_workflow_id=${CIRCLE_WORKFLOW_ID}&circle_job_num=${CIRCLE_BUILD_NUM}&stage=${CIRCLE_STAGE}&gh_username=${CIRCLE_PROJECT_USERNAME}&gh_repository=${CIRCLE_PROJECT_REPONAME}" --header "Content-Type:application/json" --data ''
jobs:
  test-1:
    machine:
      image: windows-server-2019-vs2019:stable
    resource_class: windows.medium
    steps:
    - nococid-start-job-command
    - checkout
    - run:
        name: "Test"
        command: |
            dotnet build ./NUnit.Test
            dotnet test ./NUnit.Test --no-build --logger "trx"
    - run:
        shell: powershell.exe -ExecutionPolicy Bypass
        name: "Parse Test Results"
        when: always
        command: |
            dotnet tool install -g trx2junit
            trx2junit ./NUnit.Test/TestResults/*.trx
    - store_test_results:
        path: ./NUnit.Test/TestResults
    - store_artifacts:
        path: ./NUnit.Test/TestResults
        destination: TestResults
    - nococid-end-job-command
  build-2:
    machine:
      image: windows-server-2019-vs2019:stable
    resource_class: windows.medium
    steps:
    - nococid-start-job-command
    - checkout
    - run:
        name: "Build"
        command: dotnet build ./CalculatorVS
    - store_artifacts:
        path: ./CalculatorVS/bin/Debug/netcoreapp3.1
        destination: BuiltFile
    - nococid-end-job-command
  nococid-start-workflow:
    machine:
      image: windows-server-2019-vs2019:stable
    resource_class: windows.medium
    steps:
    - nococid-start-workflow-command
workflows:
  version: 2.1
  workflow:
    jobs:
      - test-1:
          requires:
            - nococid-start-workflow
      - build-2:
          requires:
            - nococid-start-workflow
            - test-1
      - nococid-start-workflow
